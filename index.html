
<script>
    // ğŸ”‘ 1. ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆÙ…ÙØ§ØªÙŠØ­Ùƒ
    const firebaseConfig = {
        apiKey: "AIzaSyDSCsM19ILK-5nVapzgTNEjW3_l1smrpJY",
        authDomain: "pavzwe6.firebaseapp.com",
        databaseURL: "https://pavzwe6-default-rtdb.firebaseio.com",
        projectId: "pavzwe6",
        storageBucket: "pavzwe6.firebasestorage.app",
        messagingSenderId: "510449150820",
        appId: "1:510449150820:web:e05d51f2645e00cfeb6871"
    };

    let db;
    let isAdmin = false;
    let userId = localStorage.getItem('userId') || `user-${Date.now()}`;

    firebase.initializeApp(firebaseConfig);
    db = firebase.database();

    document.addEventListener('DOMContentLoaded', () => {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯Ø§Ù‹ØŒ Ù†Ø­ÙØ¸ Ù„Ù‡ Ù…Ø¹Ø±Ù‘ÙØ§Ù‹ ÙØ±ÙŠØ¯Ø§Ù‹
        if (!localStorage.getItem('userId')) {
            localStorage.setItem('userId', userId);
        }
        loadGallery();
        checkAdminStatus();
        setupKeyboard();
    });

    function checkAdminStatus() {
        if (localStorage.getItem('isAdmin') === 'true') {
            isAdmin = true;
            document.getElementById('adminPanel').classList.add('show');
            document.getElementById('logoutBtn').classList.remove('hidden');
        }
    }

    function openLoginModal() {
        document.getElementById('loginModal').classList.add('show');
        document.getElementById('adminPassword').focus();
    }

    function closeLoginModal() {
        document.getElementById('loginModal').classList.remove('show');
        document.getElementById('adminPassword').value = '';
    }

    function adminLogin() {
        const password = document.getElementById('adminPassword').value;
        const ADMIN_PASSWORD = 'admin123'; // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

        if (password === ADMIN_PASSWORD) {
            isAdmin = true;
            localStorage.setItem('isAdmin', 'true');
            document.getElementById('adminPanel').classList.add('show');
            document.getElementById('logoutBtn').classList.remove('hidden');
            closeLoginModal();
            showAlert('âœ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
            showAlert('âœ— ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
        }
    }

    function logout() {
        isAdmin = false;
        localStorage.removeItem('isAdmin');
        document.getElementById('adminPanel').classList.remove('show');
        document.getElementById('logoutBtn').classList.add('hidden');
        showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'success');
    }

    // ----------------------------------------------------
    // ğŸ”‘ 2. Ù…Ù†Ø·Ù‚ Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Upload)
    // ----------------------------------------------------

    async function uploadMedia() {
        if (!isAdmin) {
            alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value.trim();
        const type = document.getElementById('type').value;
        const url = document.getElementById('url').value.trim();

        if (!title || !url) {
            showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
            return;
        }

        try {
            const newMediaRef = db.ref('gallery').push(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… push() Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID ÙØ±ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            const itemId = newMediaRef.key;
            
            await newMediaRef.set({
                id: itemId,
                title,
                description,
                type,
                url,
                likes: 0,
                likedBy: {}, // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø£Ø¹Ø¬Ø¨ÙˆØ§ Ø¨Ø§Ù„Ù…Ù†Ø´ÙˆØ±
                createdAt: Date.now()
            });

            showAlert('âœ“ ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            document.getElementById('title').value = '';
            document.getElementById('description').value = '';
            document.getElementById('url').value = '';
            // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù€ loadGalleryØŒ Ù„Ø£Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ø¢Ù†ÙŠ Ø³ÙŠØªÙƒÙÙ„ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
        } catch (error) {
            console.error('Upload error:', error);
            showAlert('âœ— Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹', 'error');
        }
    }

    // ----------------------------------------------------
    // ğŸ”‘ 3. Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†ÙŠ (Realtime Listener)
    // ----------------------------------------------------

    function loadGallery() {
        const container = document.getElementById('galleryContainer');
        const emptyState = document.getElementById('emptyState');
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… on() Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¢Ù†ÙŠØ© (Realtime)
        db.ref('gallery').on('value', (snapshot) => {
            const items = [];
            
            if (snapshot.exists()) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… forEach Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
                snapshot.forEach(childSnapshot => {
                    const item = childSnapshot.val();
                    items.push(item);
                });
            }

            if (items.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨ØªØ±ØªÙŠØ¨ Ø¹ÙƒØ³ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            items.reverse(); 

            emptyState.style.display = 'none';
            container.innerHTML = items.map(item => createMediaCard(item)).join('');
        }, (error) => {
            console.error('Load error:', error);
            showAlert('âœ— Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰', 'error');
        });
    }

    function createMediaCard(item) {
        const isVideo = item.type === 'video';
        // ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¯ Ø£Ø¹Ø¬Ø¨ Ø¨Ø§Ù„Ù…Ù†Ø´ÙˆØ±
        const userHasLiked = item.likedBy && item.likedBy[userId] === true;
        
        const mediaHTML = isVideo
            ? `<video><source src="${item.url}"></video><div class="play-button">â–¶</div>`
            : `<img src="${item.url}" alt="${item.title}">`;

        // ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø²Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
        const likeButtonClass = userHasLiked ? 'btn-like liked' : 'btn-like';
        
        return `
            <div class="media-card" onclick="openGalleryModal('${item.type}', '${item.url}')">
                <div class="media-container">${mediaHTML}</div>
                <div class="media-info">
                    <div class="media-title">${item.title}</div>
                    <div class="media-description">${item.description || ''}</div>
                    <div class="media-actions">
                        <button class="${likeButtonClass}" onclick="toggleLike(event, '${item.id}', ${userHasLiked})">
                            ${userHasLiked ? 'â¤ï¸ ØªÙ… Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨' : 'ğŸ¤ Ø¥Ø¹Ø¬Ø§Ø¨'} (${item.likes || 0})
                        </button>
                        ${isAdmin ? `<button class="btn-delete" onclick="deleteMedia(event, '${item.id}')">Ø­Ø°Ù</button>` : ''}
                    </div>
                </div>
            </div>
        `;
    }
    
    // ----------------------------------------------------
    // ğŸ”‘ 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ (Transaction)
    // ----------------------------------------------------
    
    async function toggleLike(event, mediaId, userHasLiked) {
        event.stopPropagation();
        
        const mediaRef = db.ref(`gallery/${mediaId}`);
        
        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… transaction Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† ÙˆØ¯Ù‚ÙŠÙ‚
            await mediaRef.transaction((currentMedia) => {
                if (currentMedia) {
                    currentMedia.likes = currentMedia.likes || 0;
                    currentMedia.likedBy = currentMedia.likedBy || {};

                    if (userHasLiked) {
                        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
                        currentMedia.likes--;
                        delete currentMedia.likedBy[userId];
                    } else {
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
                        currentMedia.likes++;
                        currentMedia.likedBy[userId] = true;
                    }
                }
                return currentMedia;
            });

            // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù€ loadGalleryØŒ Ù„Ø£Ù† Ø§Ù„Ù€ on('value') Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        } catch (error) {
            console.error('Like transaction failed:', error);
            showAlert('âœ— ÙØ´Ù„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨', 'error');
        }
    }


    async function deleteMedia(event, mediaId) {
        event.stopPropagation();
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ')) return;

        try {
            await db.ref(`gallery/${mediaId}`).remove();
            showAlert('âœ“ ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
            // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± on('value')
        } catch (error) {
            console.error('Delete error:', error);
            showAlert('âœ— Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù', 'error');
        }
    }

    function openGalleryModal(type, url) {
        const modalContent = document.getElementById('modalContent');
        if (type === 'video') {
            modalContent.innerHTML = `<video controls autoplay><source src="${url}"></video>`;
        } else {
            modalContent.innerHTML = `<img src="${url}" alt="Image">`;
        }
        document.getElementById('galleryModal').classList.add('show');
    }

    function closeGalleryModal() {
        document.getElementById('galleryModal').classList.remove('show');
    }

    function showAlert(message, type) {
        const alertBox = document.getElementById('alertBox');
        alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
            alertBox.innerHTML = '';
        }, 4000);
    }

    function setupKeyboard() {
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeGalleryModal();
            if (e.key === 'Enter' && document.getElementById('loginModal').classList.contains('show')) {
                adminLogin();
            }
        });
    }
</script>
